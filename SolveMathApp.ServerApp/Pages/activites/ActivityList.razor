@page "/activites/activitylist"
@using SolveMathApp.ServerApp.Data.Services.Models
@using SolveMathApp.ServerApp.Data.Services.SolveMathService
@inject NavigationManager navManager    
@attribute [Authorize]  
@inject ISolveMathApi iSolveMathApi 


<h3>ActivityList</h3>
 

@if (!string.IsNullOrWhiteSpace(Message))
{
    <div class="alert alert-warning">
        @Message
    </div>
}

@if (activities == null || activities.Count == 0)
{
    <p>No activities available.</p>

    <button class="btn btn-sm btn-outline-primary"
            @onclick="ReloadPage">
        Reload
    </button>
}
else
{
    <table class="table table-striped table-bordered">
        <thead class="table-light">
            <tr>
                <th>Activity</th>
                <th>Description</th>
                <th>Date Created</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var activity in activities)
            {
                <tr>
                    <td>@activity.ActivityId</td>
                    <td>@activity.Description</td>
                    <td>@activity.DateCreated.ToString("yyyy-MM-dd HH:mm")</td>
                </tr>
            }
        </tbody>
    </table>

    <div class="d-flex justify-content-between align-items-center mt-3">
        <button class="btn btn-secondary"
                @onclick="PreviousPage"
                disabled="@(CurrentPage <= 1)">
            Previous
        </button>

        <span>
            Page @CurrentPage
        </span>
         


        <button class="btn btn-primary"
                @onclick="NextPage"
                disabled="@(activities.Count < PageSize)">
            Next
        </button> <span>Total Activities: @TotalSize</span>
       
    </div>
}




@code
{
    public string Message { get; set; } = string.Empty;
    public record ActivityDto(ActivityEnum ActivityId, string Description, DateTime DateCreated);

    [Parameter]
    public List<ActivityDto> activities { get; set; } = new ();

    [Parameter]
    public int TotalSize { get; set; }

    [Parameter]
    public int PageSize { get; set; } = 10;

    [Parameter]
    public int CurrentPage { get; set; } = 1;


    protected override async Task OnInitializedAsync()
    {
        var res = await iSolveMathApi.GetUserActivities(CurrentPage, PageSize);

        if(!res.Status)
        {
            // Handle error (e.g., show a message)
            activities = new List<ActivityDto>();
            TotalSize = 0;
            Message = "Error fetching activities.";
            return;
        } 

        if(res.Data == null)
        {
            activities = new List<ActivityDto>();
            TotalSize = 0;
            Message = "No activities found.";
            return;
        };

        activities = res.Data.Items?.Select(x => new ActivityDto(x.ActivityId, x.Description,x.DateCreated)).ToList() ?? new List<ActivityDto>();

        TotalSize = res.Data.PageSize;
    }

    //public NextPage()
    public async Task NextPage()
    {
        var res = await iSolveMathApi.GetUserActivities(CurrentPage++, PageSize);

        if (!res.Status)
        {
            // Handle error (e.g., show a message)
            activities = new List<ActivityDto>();
            TotalSize = 0;
            Message = "Error fetching activities.";
            return;
        }

        if (res.Data == null)
        {
            activities = new List<ActivityDto>();
            TotalSize = 0;
            Message = "No activities found.";
            return;
        }
        ;

        activities = res.Data.Items?.Select(x => new ActivityDto(x.ActivityId, x.Description, x.DateCreated)).ToList() ?? new List<ActivityDto>();

        TotalSize = res.Data.PageSize;
    }

    // public PreviousPage()
    public async Task PreviousPage()
    {
        var res = await iSolveMathApi.GetUserActivities(CurrentPage--, PageSize);
        if (!res.Status)
        {
            // Handle error (e.g., show a message)
            activities = new List<ActivityDto>();
            TotalSize = 0;
            Message = "Error fetching activities.";
            return;
        }

        if (res.Data == null)
        {
            activities = new List<ActivityDto>();
            TotalSize = 0;
            Message = "No activities found.";
            return;
        }
        ;

        activities = res.Data.Items?.Select(x => new ActivityDto(x.ActivityId, x.Description, x.DateCreated)).ToList() ?? new List<ActivityDto>();

        TotalSize = res.Data.PageSize;
    }

    //reload page.
    public async Task ReloadPage()
    {
        await OnInitializedAsync();
    }

}
